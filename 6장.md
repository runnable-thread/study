

# Docker 좀더 활용하기 

## Docker Private Registry 환경 구축 

- Docker hub 공식 저장소에서 registry 이미지 다운로드
  - docker image pull registry

- docker container run -d -p []:[port] --name [컨테이너명] registry
  - docker container run -d -p 5000:5000 --name registry registry
 
 
 - local에 
 ``` 
 sudo docker run -d -p 5000:5000 --name hello-registry     -v /tmp/registry:/tmp/registry registry
 ```
  
 ## 태그를 먼저 생성하고 push를 할 수 있음
 
 $ sudo docker tag hello:0.1 localhost:5000/hello:0.1
$ sudo docker push localhost:5000/hello:0.1


## aws s3에 이미지 파일을 올리는 법 

```
sudo docker run -d -p 5000:5000 --name s3-registry \
    -e SETTINGS_FLAVOR=s3 \
    -e AWS_BUCKET=examplebucket10 \
    -e STORAGE_PATH=/registry \
    -e AWS_KEY=AKIABCDEFGHIJKLMNOPQ \
    -e AWS_SECRET=sF4321ABCDEFGHIJKLMNOPqrstuvwxyz21345Afc \
    registry
```

-e 옵션 으로 지정. 


## 두개의 컨테이너 사이에서 네트워크를 연결하는 방법

-- network 옵션 

- network생성
  - sudo docker network create hello-network
  
- db 생성
  -   docker run --name db -d --network hello-network mongo
  
- web server 생성
  - docker run --name web -d -p 80:80 --network hello-network nginx


## 다른 서버의 docker container에 연결하는 방법

- 엠베서더 컨테이너라는 중간 interface가 같은 서버내의 도커 처럼 종속적이지 않게 바꿔줌 


```
기본 레디스 컨테이너 생성
 sudo docker pull redis:latest
 sudo docker run -d --name redis redis:latest
 
레디스 컨테이너를 위한 앰베세더 컨테이너 
 sudo docker run -d --link redis:redis --name redis_ambassador \
    -p 6379:6379 svendowideit/ambassador
   
   
레디스 클라이언트를 사용할 컴퓨터에서 앰배서더 컨테이너를 생성 
  - 
   
```


# Volume

- 데이터는 호스트가 아닌 컨테이너에 저장되는 구조 
- 컨테이너끼리 용이하게 공유가 가능
- docker commit을 해도 volume은 반영되지 않음



# DockerFile

## 구성

- 도커파일을 기반으로 이미지 생성할 수 있음
``<명령> <매개 변수>``
- FROM으로 시작, 
- 각 명령은 독립적으로 수행 됨
- Dockerfile이 있는 디렉토리에서 docekr build 실행


## 명령어들 
### .dockerignore 

- 도커 폴더 내에 있는 다른 모든 파일들은 context이기때문에 이미지 생성할때 같이 docker daemon에 전송하게됨
- 컨텍스트 내의 파일이나 디렉토리 제외하고 싶을때 사용
- go 기반

```
example/hello.txt
example/*.cpp
wo*
*.cpp
.git
.svn
```

### FROM

- 베이스 이미지 설정 
```FROM <이미지> 또는 FROM <이미지>:<태그>```

- 로컬에 있으면 로컬, 없으면 Docker hub
- 여러개의 이미지 설정 가능 (2개의 이미지가 생김)

### MAINTAINER 
- 이미지를 생성한 사람의 정보 
```MAINTAINER  <작성자 정보> ```

### RUN
- FROM에서 설정한 이미지 위에서 스크립트 또는 명령어를 실행
- RUN으로 실행한 결과가 새 이미지로 생성되고, 실행 내역은 이미지의 히스토리에 저장됨

- /bin/sh 로 실행 (없으면 사용 불가)
```
RUN apt-get install -y nginx
RUN echo "Hello Docker" > /tmp/hello
RUN curl -sSL https://golang.org/dl/go1.3.1.src.tar.gz | tar -v -C /usr/local -xz
RUN git clone https://github.com/docker/docker.git
```

- 셀없이 사용
```
RUN ["apt-get", "install", "-y", "nginx"]
RUN ["/user/local/bin/hello", "--help"]
```
- cache로 저장되어서 사용 됨

--no-cache 옵션으로 캐싱없이 사용 가능 


### CMD 
- 컨테이너가 시작되었을때, 스크립트 혹은 명령을 실행, 즉 docker run 이나 start 명령으로 정지된 컨테이너를 시작할 때 실행됨
- Docker file에서 한번만 사용 가능

```
/bin/sh
CMD touch /home/hello/hello.txt

ENTRYPOINT를 사용
ENTRYPOINT에 설정한 명령에 매개변수를 전달하여 실행 

ENTRYPOINT ["echo"]
CMD ["hello"]

```

### ENTRYPOINT

- 컨테이너가 시작되었을때, 스크립트 또는 명령어를 실행 (CMD와 유사)

ENTRYPOINT touch /home/hello/hello.txt


https://blog.leocat.kr/notes/2017/01/08/docker-run-vs-cmd-vs-entrypoint
https://bluese05.tistory.com/77
